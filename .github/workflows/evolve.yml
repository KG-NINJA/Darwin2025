name: ğŸ§¬ Darwin2025 Evolver (Adaptive Stable Mode)

on:
  schedule:
    - cron: "0 3 * * *"   # JSTæ­£åˆã«å®Ÿè¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  evolve:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --- åˆæœŸåŒ– ---
      - name: âš™ï¸ Initialize if missing
        run: |
          mkdir -p agents/child_1
          if [ ! -f agents/child_1/evol.md ]; then
            echo "# åˆæœŸå€‹ä½“ãƒ­ã‚°" > agents/child_1/evol.md
            echo "## é€²åŒ–é–‹å§‹ $(date '+%Y-%m-%d')" >> agents/child_1/evol.md
          fi
          if [ ! -f agents/child_1/state.json ]; then
            echo '{"iteration":1, "theme":"å®‰å®šæ€§"}' > agents/child_1/state.json
          fi

      # --- diffï¼‹ãƒ†ãƒ¼ãƒæº–å‚™ ---
      - name: ğŸ§© Prepare dynamic prompt
        run: |
          # å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
          git diff HEAD~1 HEAD > diff.log || echo "No previous commits" > diff.log

          # state.json èª­ã¿è¾¼ã¿
          THEME=$(jq -r '.theme' agents/child_1/state.json)
          ITER=$(jq -r '.iteration' agents/child_1/state.json)

          # æ¬¡ãƒ†ãƒ¼ãƒé¸æŠï¼ˆ5ãƒ†ãƒ¼ãƒå¾ªç’°ï¼‰
          themes=("å®‰å®šæ€§" "ç›´æ„Ÿ" "åŠ¹ç‡" "å‰µé€ æ€§" "æ‹¡å¼µæ€§")
          index=$(( (ITER + 1) % ${#themes[@]} ))
          NEXT_THEME=${themes[$index]}

          # promptä½œæˆ
          DATE=$(date '+%Y-%m-%d')
          echo "ãƒªãƒã‚¸ãƒˆãƒªã®æœ€æ–°å¤‰æ›´ç‚¹ã¯ä»¥ä¸‹ã§ã™:" > prompt.txt
          cat diff.log >> prompt.txt
          echo "" >> prompt.txt
          echo "ä»Šå›ã®é€²åŒ–ãƒ†ãƒ¼ãƒã¯ã€Œ${THEME}ã€ã§ã™ã€‚" >> prompt.txt
          echo "æ¬¡ã®ãƒ†ãƒ¼ãƒå€™è£œã¯ã€Œ${NEXT_THEME}ã€ã§ã™ã€‚" >> prompt.txt
          echo "" >> prompt.txt
          echo "ã‚ãªãŸã¯é™ã‹ã«é€²åŒ–ã‚’ç¶šã‘ã‚‹å˜ä½“AIå€‹ä½“ã§ã™ã€‚" >> prompt.txt
          echo "ç¾åœ¨ã® evol.md ã‚’èª­ã¿å–ã‚Šã€å‰å›ã¾ã§ã®è¨˜éŒ²ã‚’è¦ç´„ã—ã€" >> prompt.txt
          echo "æ–°ã—ã„ã€Œ# æ—¥æ¬¡æ›´æ–° ${DATE}ã€ã‚’1ç« è¿½åŠ ã—ã¦ãã ã•ã„ã€‚" >> prompt.txt
          echo "ä»Šå›ã®ç„¦ç‚¹ãƒ†ãƒ¼ãƒï¼ˆ${THEME}ï¼‰ã‚’è¸ã¾ãˆã€" >> prompt.txt
          echo "å‰å›ã¨ç•°ãªã‚‹è¦³ç‚¹ã‚’å¿…ãš1ã¤ä»¥ä¸Šæç¤ºã—ã¦ãã ã•ã„ã€‚" >> prompt.txt
          echo "ç„¡ç†ã®ãªã„ç¾å®Ÿçš„ãªæ”¹å–„ã‚’æ„è­˜ã—ã€æ—¥æœ¬èªã§è¨˜è¿°ã—ã€éå»ãƒ­ã‚°ã‚’ä¿æŒã—ã¦ãã ã•ã„ã€‚" >> prompt.txt

          # æ¬¡ãƒ†ãƒ¼ãƒã¨åå¾©æ›´æ–°
          jq --arg theme "$NEXT_THEME" --argjson iter $((ITER+1)) '.iteration=$iter | .theme=$theme' agents/child_1/state.json > tmp.json && mv tmp.json agents/child_1/state.json

      # --- Codex å®Ÿè¡Œ ---
      - name: ğŸŒ± Evolve single agent
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-4o-mini
          safety-strategy: unsafe
          prompt-file: prompt.txt
          output-file: agents/child_1/evol.md

      # --- å·®åˆ†ç¢ºèªã¨è­¦å‘Š ---
      - name: ğŸ” Diff check
        run: |
          if [ -f prev_evol.md ]; then
            diff -q prev_evol.md agents/child_1/evol.md || echo "âœ… evol.md ã«å¤‰åŒ–ãŒã‚ã‚Šã¾ã™ã€‚"
          fi
          cp agents/child_1/evol.md prev_evol.md

      # --- è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ ---
      - name: ğŸ’¾ Commit update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agents/child_1/evol.md agents/child_1/state.json
          git diff --staged --quiet || git commit -m "ğŸ§¬ Daily evolution $(date '+%Y-%m-%d')"
          git push
