name: ğŸ§¬ Darwin2025 Swarm Evolver (auto-cyclic mode)

on:
  schedule:
    - cron: "0 3 * * *"   # JSTæ­£åˆã«æ¯æ—¥å®Ÿè¡Œï¼ˆUTC 03:00ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # åˆæœŸæ§‹é€ ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆåˆå›ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ï¼‰
      - name: âš™ï¸ Initialize if missing
        run: |
          mkdir -p agents/child_1 agents/child_2 agents/child_3
          for c in agents/child_1 agents/child_2 agents/child_3; do
            if [ ! -f "$c/evol.md" ]; then
              echo "# åˆæœŸå€‹ä½“ãƒ­ã‚°" > "$c/evol.md"
              echo "## é€²åŒ–é–‹å§‹ $(date '+%Y-%m-%d')" >> "$c/evol.md"
            fi
          done
          if [ ! -f evol_master.md ]; then
            echo "# ç¾¤ä½“é€²åŒ–ãƒã‚¹ã‚¿ãƒ¼è¨˜éŒ²" > evol_master.md
            echo "åˆæœŸç”Ÿæˆ $(date '+%Y-%m-%d')" >> evol_master.md
          fi

      # å„å­å€‹ä½“ã‚’ç‹¬ç«‹çš„ã«é€²åŒ–ã•ã›ã‚‹
      - name: ğŸŒ± Evolve each child
        run: |
          for c in agents/child_1 agents/child_2 agents/child_3; do
            echo "é€²åŒ–å‡¦ç†ä¸­: $c"
            npx -y @openai/codex \
              run \
              --model gpt-4o-mini \
              --input-file "$c/evol.md" \
              --output-file "$c/evol.md" \
              --prompt "ã‚ãªãŸã¯ç‹¬ç«‹ã—ãŸAIå€‹ä½“ã§ã™ã€‚å‰å›ã®è¨˜éŒ²ã‚’ç°¡æ½”ã«è¦ç´„ã—ã€æ–°ã—ã„æ—¥æ¬¡æ›´æ–°ã‚’1ç« è¿½åŠ ã—ã¦ãã ã•ã„ã€‚å¿…ãšæ—¥æœ¬èªã§æ›¸ãã€éå»ãƒ­ã‚°ã‚’ä¿æŒã—ã¦ãã ã•ã„ã€‚" \
              -- --api-key ${{ secrets.OPENAI_API_KEY }}
          done

      # ç¾¤ä½“å…¨ä½“ã‚’è¦³æ¸¬ã—å…±é€šçŸ¥è¦‹ã‚’ç”Ÿæˆ
      - name: ğŸ§  Summarize swarm insights
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-4o-mini
          safety-strategy: unsafe
          prompt: |
            ã‚ãªãŸã¯ç¾¤ä½“é€²åŒ–ã‚’è¦³æ¸¬ã™ã‚‹AIç ”ç©¶è€…ã§ã™ã€‚
            agentsä»¥ä¸‹ã®ã™ã¹ã¦ã®evol.mdã‚’èª­ã¿å–ã‚Šã€
            ä»Šæ—¥ã®é€²åŒ–å‚¾å‘ãƒ»å”èª¿ãƒ»æ–°ã—ã„çŸ¥è¦‹ã‚’æ—¥æœ¬èªã§è¦ç´„ã—ã€
            evol_master.md ã®æœ«å°¾ã«ã€Œ# å…±é€šçŸ¥è¦‹ {{ date }}ã€ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
            æ§‹é€ ã‚’ä¿æŒã—ã€éå»ãƒ­ã‚°ã‚’æ¶ˆã•ãšã«è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚
          input-files: |
            agents/child_1/evol.md
            agents/child_2/evol.md
            agents/child_3/evol.md
          output-file: evol_master.md

      # æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦GitHubã«åæ˜ 
      - name: ğŸ’¾ Commit updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agents/ evol_master.md
          git diff --staged --quiet || git commit -m "ğŸ§¬ Swarm auto-coevolution update $(date '+%Y-%m-%d')"
          git push
