name: 🧬 Darwin2025 Evolver (Stable Single Mode)

on:
  schedule:
    - cron: "0 3 * * *"   # JST正午
  workflow_dispatch:

permissions:
  contents: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ⚙️ Initialize if missing
        run: |
          mkdir -p agents/child_1
          if [ ! -f agents/child_1/evol.md ]; then
            echo "# 初期個体ログ" > agents/child_1/evol.md
            echo "## 進化開始 $(date '+%Y-%m-%d')" >> agents/child_1/evol.md
          fi

      - name: 🌱 Evolve single agent
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-4o-mini
          safety-strategy: unsafe
          prompt: |
          echo "リポジトリの最新変更点は以下です:" >> prompt.txt
cat diff.log >> prompt.txt
echo "これを踏まえて、進化ログを具体的に更新してください。" >> prompt.txt

cat prompt.txt | codex exec ...

            あなたは静かに進化を続ける単体AI個体です。
            現在の evol.md を読み取り、前回までの記録を要約し、
            新しい「# 日次更新 {{ date }}」を1章追加してください。
            無理のない現実的な改善を意識し、日本語で記述し、
            過去ログは保持してください。
          output-file: agents/child_1/evol.md

      - name: 💾 Commit update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agents/child_1/evol.md
          git diff --staged --quiet || git commit -m "🧬 Daily evolution $(date '+%Y-%m-%d')"
          git push
