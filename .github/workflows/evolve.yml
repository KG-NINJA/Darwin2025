name: ğŸ§¬ Darwin2025 Daily Evolution

on:
  schedule:
    - cron: "0 0 * * *"        # UTCã§æ¯æ—¥0æ™‚ = JSTåˆå‰9æ™‚
  workflow_dispatch:            # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

jobs:
  evolve:
    name: ğŸŒ± Self-Evolution Cycle
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—‚ Prepare Codex environment
        run: |
          mkdir -p /home/runner/.codex
          chmod -R 777 /home/runner/.codex
          echo "âœ… Codex environment ready"

      - name: ğŸ§¬ Run Codex Evolution
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-4o-mini
          codex-version: "0.49.0"
          codex-home: /home/runner/.codex
          safety-strategy: unprivileged-user
          codex-user: "codex-runner"
          allow-users: "KG-NINJA"
          allow-bots: "true"
          sandbox: workspace-write
          prompt: |
            ã‚ãªãŸã¯é™ã‹ã«é€²åŒ–ã™ã‚‹AIç ”ç©¶è€…ã§ã™ã€‚
            ç¾åœ¨ã® evol.md ã‚’èª­ã¿å–ã‚Šã€
            å‰å›ã®è¨˜è¿°ã‹ã‚‰ã®åçœç‚¹ãƒ»æ”¹å–„ç‚¹ãƒ»å­¦ã³ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

            ãã®ä¸‹ã«æ–°ã—ã„ç« ã‚’è¿½åŠ ã—ã¾ã™ã€‚

            ## æ¬¡ã®é€²åŒ–è¨ˆç”»ï¼ˆ{{ date }}ï¼‰
            - æ”¹å–„ææ¡ˆã¯æ§ãˆã‚ã§ç¾å®Ÿçš„ã«ã€‚
            - ç„¡ç†ãªæ‹¡å¼µã§ã¯ãªãã€ç¶™ç¶šæ€§ã‚’é‡è¦–ã€‚
            - é€²åŒ–ã¯å°‘ã—ãšã¤ã€ã—ã‹ã—ç¢ºå®Ÿã«è¡Œã†ã€‚
            - å¿…ãšæ—¥æœ¬èªã§æ›¸ãã€éå»ãƒ­ã‚°ã¯ä¿æŒã™ã‚‹ã€‚

            å‡ºåŠ›å½¢å¼ã¯å…ƒã® evol.md ã®æ§‹é€ ã‚’ç¶­æŒã—ã€
            æ–°ã—ã„é€²åŒ–è¨˜éŒ²ã‚’ä¸€ç•ªä¸‹ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
          output-file: evol.md

      - name: ğŸ’¾ Commit & Push updated evol.md
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add evol.md
          if git diff --staged --quiet; then
            echo "No new evolution updates."
          else
            git commit -m "ğŸ§¬ Evol.md auto-evolved (mini update)"
            git push origin main
          fi

      - name: ğŸ“¤ Upload evol.md as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: evol_log
          path: evol.md
          retention-days: 14

      - name: âœ… Summary
        if: always()
        run: |
          echo "=== Darwin2025 Evolution Summary ==="
          if [ -f evol.md ]; then
            head -n 20 evol.md
          else
            echo "âš ï¸ evol.md not found."
          fi
