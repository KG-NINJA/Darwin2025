name: ğŸ§¬ Darwin2025 Evolver (Code Evolution Mode)
on:
  schedule:
    - cron: "0 3 * * *"   # JSTæ­£åˆã«å®Ÿè¡Œ
  workflow_dispatch:
permissions:
  contents: write
jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # --- åˆæœŸåŒ– ---
      - name: âš™ï¸ Initialize if missing
        run: |
          mkdir -p agents/child_1/codes
          mkdir -p agents/child_1/tests
          if [ ! -f agents/child_1/evol.md ]; then
            echo "# åˆæœŸå€‹ä½“ãƒ­ã‚°" > agents/child_1/evol.md
            echo "## é€²åŒ–é–‹å§‹ $(date '+%Y-%m-%d')" >> agents/child_1/evol.md
          fi
          if [ ! -f agents/child_1/state.json ]; then
            echo '{"iteration":1, "theme":"å®‰å®šæ€§", "best_score":0}' > agents/child_1/state.json
          fi
      
      # --- diff + ãƒ†ãƒ¼ãƒæº–å‚™ ---
      - name: ğŸ§© Prepare dynamic prompt
        run: |
          git diff HEAD~1 HEAD > diff.log 2>/dev/null || echo "No previous commits" > diff.log
          THEME=$(jq -r '.theme' agents/child_1/state.json)
          ITER=$(jq -r '.iteration' agents/child_1/state.json)
          BEST_SCORE=$(jq -r '.best_score' agents/child_1/state.json)
          
          themes=("å®‰å®šæ€§" "ç›´æ„Ÿ" "åŠ¹ç‡" "å‰µé€ æ€§" "æ‹¡å¼µæ€§")
          index=$(( (ITER + 1) % ${#themes[@]} ))
          NEXT_THEME=${themes[$index]}
          
          DATE=$(date '+%Y-%m-%d')
          python3 << PYSCRIPT
          import os
          theme = "$THEME"
          next_theme = "$NEXT_THEME"
          best_score = "$BEST_SCORE"
          iter_num = "$ITER"
          date_str = "$DATE"
          
          prompt = f"""ã‚ãªãŸã¯é€²åŒ–ã™ã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
          ä»¥ä¸‹ã¯å‰å›ã¾ã§ã®æ”¹å–„ãƒ­ã‚°ã§ã™ï¼š
          
          ---PREVIOUS_EVOL---
          """
          
          if os.path.exists('agents/child_1/evol.md'):
              with open('agents/child_1/evol.md', 'r') as f:
                  lines = f.readlines()
                  prompt += "".join(lines[-100:])
          
          with open('diff.log', 'r') as f:
              diff_content = f.read()
          
          prompt += f"""
          ---DIFF---
          {diff_content}
          
          ---TASK---
          é€²åŒ–ãƒ†ãƒ¼ãƒ: ã€Œ{theme}ã€
          æ¬¡ã®ãƒ†ãƒ¼ãƒ: ã€Œ{next_theme}ã€
          ç¾åœ¨ã®ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢: {best_score}
          åå¾©å›æ•°: {iter_num}
          
          ä»¥ä¸‹ã®Pythonã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ”¹å–„ã—ã¦ãã ã•ã„ï¼š
          1. ç¾åœ¨ã®å•é¡Œç‚¹ã‚’ç‰¹å®šã™ã‚‹
          2. ãƒ†ãƒ¼ãƒã€Œ{theme}ã€ã«åŸºã¥ã„ãŸæ”¹å–„æ¡ˆã‚’ææ¡ˆã™ã‚‹
          3. å®Ÿè£…å¯èƒ½ãªPythonã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆé–¢æ•°å½¢å¼ï¼‰
          4. ãƒ†ã‚¹ãƒˆå¯èƒ½ãªæŒ‡æ¨™ã‚’è¨˜è¿°ã™ã‚‹
          
          å‡ºåŠ›å½¢å¼ï¼š
          # æ—¥æ¬¡æ›´æ–° {date_str}
          ## æ”¹å–„ãƒ†ãƒ¼ãƒåˆ†æ
          [åˆ†æå†…å®¹]
          
          ## ææ¡ˆã‚³ãƒ¼ãƒ‰
          ```python
          [æ”¹å–„ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰]
          ```
          
          ## ãƒ†ã‚¹ãƒˆæ–¹æ³•
          [ãƒ†ã‚¹ãƒˆæ–¹æ³•ã®èª¬æ˜]
          """
          
          with open('prompt.txt', 'w') as f:
              f.write(prompt)
          PYSCRIPT
      
      # --- ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ ---
      - name: ğŸŒ± Generate evolution text
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-4o-mini
          prompt-file: prompt.txt
          output-file: evolution_proposal.md
      
      # --- ã‚³ãƒ¼ãƒ‰æŠ½å‡º ---
      - name: ğŸ“„ Extract code from proposal
        run: |
          python3 << 'PYEOF'
          import re
          
          with open('evolution_proposal.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Pythonã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯æŠ½å‡º
          pattern = r'```python\n(.*?)\n```'
          matches = re.findall(pattern, content, re.DOTALL)
          
          if matches:
              code = matches[0]
              with open('agents/child_1/codes/proposal_latest.py', 'w', encoding='utf-8') as f:
                  f.write(code)
              print("âœ… Code extracted successfully")
          else:
              print("âš ï¸ No code block found")
              exit(1)
          PYEOF
      
      # --- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ---
      - name: ğŸ§ª Test generated code
        run: |
          python3 << 'PYEOF'
          import sys
          import json
          
          try:
              # ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
              sys.path.insert(0, 'agents/child_1/codes')
              
              # ç°¡å˜ãªãƒ†ã‚¹ãƒˆï¼šã‚³ãƒ¼ãƒ‰ãŒæ§‹æ–‡çš„ã«æ­£ã—ã„ã‹
              with open('agents/child_1/codes/proposal_latest.py', 'r') as f:
                  code = f.read()
              
              compile(code, 'proposal_latest.py', 'exec')
              
              # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å†…ï¼‰
              namespace = {}
              exec(code, namespace)
              
              # é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
              functions = [name for name in namespace if callable(namespace[name]) and not name.startswith('_')]
              
              if functions:
                  test_result = {
                      "status": "PASS",
                      "functions_found": functions,
                      "score": 0.8
                  }
                  print("âœ… Code test PASSED")
              else:
                  test_result = {
                      "status": "FAIL",
                      "error": "No functions defined",
                      "score": 0
                  }
                  print("âŒ Code test FAILED")
              
              with open('test_result.json', 'w') as f:
                  json.dump(test_result, f)
          
          except SyntaxError as e:
              test_result = {"status": "FAIL", "error": f"Syntax error: {e}", "score": 0}
              with open('test_result.json', 'w') as f:
                  json.dump(test_result, f)
              print(f"âŒ Syntax error: {e}")
          except Exception as e:
              test_result = {"status": "FAIL", "error": str(e), "score": 0}
              with open('test_result.json', 'w') as f:
                  json.dump(test_result, f)
              print(f"âŒ Runtime error: {e}")
          PYEOF
      
      # --- ã‚¹ã‚³ã‚¢è©•ä¾¡ ---
      - name: ğŸ“Š Evaluate score
        run: |
          python3 << 'PYEOF'
          import json
          
          with open('test_result.json', 'r') as f:
              test_result = json.load(f)
          
          with open('agents/child_1/state.json', 'r') as f:
              state = json.load(f)
          
          current_score = test_result.get('score', 0)
          best_score = state.get('best_score', 0)
          
          # ã‚¹ã‚³ã‚¢æ›´æ–°
          if current_score > best_score:
              state['best_score'] = current_score
              state['last_improvement'] = True
              print(f"ğŸ¯ New best score: {current_score} (was {best_score})")
          else:
              state['last_improvement'] = False
              print(f"ğŸ“ˆ Score: {current_score} (best: {best_score})")
          
          with open('agents/child_1/state.json', 'w') as f:
              json.dump(state, f)
          PYEOF
      
      # --- ãƒ­ã‚°æ›´æ–° ---
      - name: ğŸ“ Update evolution log
        run: |
          python3 << 'PYEOF'
          import json
          from datetime import datetime
          
          with open('evolution_proposal.md', 'r') as f:
              proposal = f.read()
          
          with open('test_result.json', 'r') as f:
              test_result = json.load(f)
          
          with open('agents/child_1/state.json', 'r') as f:
              state = json.load(f)
          
          log_entry = f"""
          {proposal}
          
          ## ãƒ†ã‚¹ãƒˆçµæœ
          - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {test_result['status']}
          - ã‚¹ã‚³ã‚¢: {test_result.get('score', 0)}
          - è©³ç´°: {test_result.get('error', 'N/A')}
          - ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢: {state['best_score']}
          
          ---
          """
          
          with open('agents/child_1/evol.md', 'a', encoding='utf-8') as f:
              f.write(log_entry)
          
          print("âœ… Log updated")
          PYEOF
      
      # --- ã‚³ãƒ¼ãƒ‰ä¿å­˜ï¼ˆæˆåŠŸæ™‚ï¼‰ ---
      - name: ğŸ’¾ Archive successful code
        run: |
          python3 << 'PYEOF'
          import json
          import shutil
          from datetime import datetime
          
          with open('test_result.json', 'r') as f:
              test_result = json.load(f)
          
          if test_result['status'] == 'PASS':
              timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
              archive_name = f"agents/child_1/codes/success_{timestamp}.py"
              shutil.copy('agents/child_1/codes/proposal_latest.py', archive_name)
              print(f"âœ… Code archived: {archive_name}")
          PYEOF
      
      # --- çŠ¶æ…‹æ›´æ–° ---
      - name: ğŸ”„ Update state
        run: |
          python3 << 'PYEOF'
          import json
          
          with open('agents/child_1/state.json', 'r') as f:
              state = json.load(f)
          
          themes = ["å®‰å®šæ€§", "ç›´æ„Ÿ", "åŠ¹ç‡", "å‰µé€ æ€§", "æ‹¡å¼µæ€§"]
          next_index = (state['iteration'] + 1) % len(themes)
          state['iteration'] += 1
          state['theme'] = themes[next_index]
          
          with open('agents/child_1/state.json', 'w') as f:
              json.dump(state, f, indent=2)
          PYEOF
      
      # --- è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ ---
      - name: ğŸš€ Commit evolution
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agents/child_1/evol.md agents/child_1/state.json agents/child_1/codes/
          git diff --staged --quiet || git commit -m "ğŸ§¬ Evolution iteration $(date '+%Y-%m-%d') - Code evolved"
          git push
