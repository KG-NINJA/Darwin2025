name: 🧬 Darwin2025 Swarm Evolver (auto-cyclic mode)

on:
  schedule:
    - cron: "0 3 * * *"   # JST正午に毎日実行（UTC 03:00）
  workflow_dispatch:

permissions:
  contents: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 初期構造を自動生成（初回でもエラーにならない）
      - name: ⚙️ Initialize if missing
        run: |
          mkdir -p agents/child_1 agents/child_2 agents/child_3
          for c in agents/child_1 agents/child_2 agents/child_3; do
            if [ ! -f "$c/evol.md" ]; then
              echo "# 初期個体ログ" > "$c/evol.md"
              echo "## 進化開始 $(date '+%Y-%m-%d')" >> "$c/evol.md"
            fi
          done
          if [ ! -f evol_master.md ]; then
            echo "# 群体進化マスター記録" > evol_master.md
            echo "初期生成 $(date '+%Y-%m-%d')" >> evol_master.md
          fi

      # 各子個体を独立的に進化させる
      - name: 🌱 Evolve each child
        run: |
          for c in agents/child_1 agents/child_2 agents/child_3; do
            echo "進化処理中: $c"
            npx -y @openai/codex \
              run \
              --model gpt-4o-mini \
              --input-file "$c/evol.md" \
              --output-file "$c/evol.md" \
              --prompt "あなたは独立したAI個体です。前回の記録を簡潔に要約し、新しい日次更新を1章追加してください。必ず日本語で書き、過去ログを保持してください。" \
              -- --api-key ${{ secrets.OPENAI_API_KEY }}
          done

      # 群体全体を観測し共通知見を生成
      - name: 🧠 Summarize swarm insights
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-4o-mini
          safety-strategy: unsafe
          prompt: |
            あなたは群体進化を観測するAI研究者です。
            agents以下のすべてのevol.mdを読み取り、
            今日の進化傾向・協調・新しい知見を日本語で要約し、
            evol_master.md の末尾に「# 共通知見 {{ date }}」を追加してください。
            構造を保持し、過去ログを消さずに追記してください。
          input-files: |
            agents/child_1/evol.md
            agents/child_2/evol.md
            agents/child_3/evol.md
          output-file: evol_master.md

      # 更新をコミットしてGitHubに反映
      - name: 💾 Commit updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agents/ evol_master.md
          git diff --staged --quiet || git commit -m "🧬 Swarm auto-coevolution update $(date '+%Y-%m-%d')"
          git push
